<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beowulf - Clinical Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Beowulf</a>
            <div>
                <a href="/" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
                <a href="/orders.html" class="btn btn-outline-light btn-sm me-2">Orders</a>
                <a href="/swagger-ui.html" class="btn btn-outline-info btn-sm" target="_blank">API Docs</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>Dashboard</h1>
        <p class="text-muted">Clinical Order Management System</p>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><strong>Studies by Status</strong></div>
                    <div class="card-body" id="studyStats">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><strong>Orders by Type</strong></div>
                    <div class="card-body" id="orderStats">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <a href="/orders.html#create" class="btn btn-success btn-lg w-100">Create Order</a>
            </div>
            <div class="col-md-6">
                <a href="/orders.html" class="btn btn-primary btn-lg w-100">View Orders</a>
            </div>
        </div>

        <div class="mt-5 text-center">
            <p><em>Nor have I ever seen,<br>
            Out of all the men on earth, one greater<br>
            Than has come with you; no commoner carries<br>
            Such weapons, unless his appearance, and his beauty,<br>
            Are both lies.</em></p>
        </div>
    </div>

    <script>
        const API = '';

        async function loadStats() {
            try {
                const [studyRes, orderRes] = await Promise.all([
                    fetch(API + '/api/reports/study-status-summary'),
                    fetch(API + '/api/reports/orders-by-type')
                ]);

                const studyData = await studyRes.json();
                const orderData = await orderRes.json();

                let studyHtml = '<table class="table table-sm"><tbody>';
                let totalStudies = 0;
                for (const [status, count] of Object.entries(studyData)) {
                    studyHtml += `<tr><td><span class="badge bg-${statusColor(status)}">${status}</span></td><td>${count}</td></tr>`;
                    totalStudies += count;
                }
                studyHtml += `</tbody><tfoot><tr><td><strong>Total</strong></td><td><strong>${totalStudies}</strong></td></tr></tfoot></table>`;
                document.getElementById('studyStats').innerHTML = totalStudies > 0 ? studyHtml : '<p class="text-muted">No studies yet. Create an order to get started.</p>';

                let orderHtml = '<table class="table table-sm"><tbody>';
                let totalOrders = 0;
                for (const [type, count] of Object.entries(orderData)) {
                    orderHtml += `<tr><td>${type}</td><td>${count}</td></tr>`;
                    totalOrders += count;
                }
                orderHtml += `</tbody><tfoot><tr><td><strong>Total</strong></td><td><strong>${totalOrders}</strong></td></tr></tfoot></table>`;
                document.getElementById('orderStats').innerHTML = totalOrders > 0 ? orderHtml : '<p class="text-muted">No orders yet.</p>';
            } catch (e) {
                document.getElementById('studyStats').innerHTML = '<p class="text-danger">Failed to load stats</p>';
                document.getElementById('orderStats').innerHTML = '<p class="text-danger">Failed to load stats</p>';
            }
        }

        function statusColor(status) {
            switch(status) {
                case 'ORDERED': return 'primary';
                case 'FINALIZED': return 'success';
                case 'AMENDED': return 'warning';
                case 'CANCELED': return 'secondary';
                default: return 'info';
            }
        }

        loadStats();
    </script>
</body>
</html>
